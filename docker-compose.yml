services:
  telenexus:
    build:
      context: .
      args:
        APP_GIT_SHA: ${APP_GIT_SHA:-unknown}
        APP_BUILD_TIME: ${APP_BUILD_TIME:-unknown}
    env_file: .env
    environment:
      TZ: Asia/Taipei
      TELEGRAM_TOKEN: ${TELEGRAM_TOKEN}
      ALLOWED_USER_ID: ${ALLOWED_USER_ID}
      DB_PATH: /app/data/moltbot.db
      DB_DIR: /app/data
      GEMINI_PROJECT_DIR: /app
      WEB_ENABLED: ${WEB_ENABLED:-true}
      WEB_BIND: ${WEB_BIND:-0.0.0.0}
      WEB_PORT: ${WEB_PORT:-3030}
      WEB_AUTH_TOKEN: ${WEB_AUTH_TOKEN:-}
      WEB_TRUST_PRIVATE_NETWORK: ${WEB_TRUST_PRIVATE_NETWORK:-false}
      WEB_ALERT_ERROR_THRESHOLD: ${WEB_ALERT_ERROR_THRESHOLD:-1}
      WEB_ALERT_RUNNER_SUCCESS_WARN_THRESHOLD: ${WEB_ALERT_RUNNER_SUCCESS_WARN_THRESHOLD:-80}
      WEB_USER_ID: ${WEB_USER_ID:-}
      RUNNER_ENDPOINT: ${RUNNER_ENDPOINT:-}
      SCHEDULE_USE_RUNNER: ${SCHEDULE_USE_RUNNER:-true}
      CHAT_USE_RUNNER_PERCENT: ${CHAT_USE_RUNNER_PERCENT:-100}
      CHAT_USE_RUNNER_ONLY_USERS: ${CHAT_USE_RUNNER_ONLY_USERS:-}
      RUNNER_SHARED_SECRET: ${RUNNER_SHARED_SECRET:-}
      RUNNER_FAILURE_THRESHOLD: ${RUNNER_FAILURE_THRESHOLD:-3}
      RUNNER_COOLDOWN_MS: ${RUNNER_COOLDOWN_MS:-60000}
    ports:
      - ${WEB_PORT:-3030}:${WEB_PORT:-3030}
    volumes:
      - ./data:/app/data
      - ./workspace:/app/workspace
      - ./workspace/.gemini:/app/workspace/.gemini
      - gemini_workspace_skills:/app/workspace/.gemini/skills
      - ./workspace/.opencode:/app/workspace/.opencode
      - ./ai-config.yaml:/app/ai-config.yaml:ro
      - gemini_auth:/root/.gemini
      # 掛載本地 opencode 認證和資料 (需先確保本地已登入)
      - ${HOME}/.local/share/opencode:/root/.local/share/opencode
      - ./skills:/app/skills:ro
      - ./GEMINI.md:/app/workspace/GEMINI.md:ro
      - ./AGENTS.md:/app/workspace/AGENTS.md:ro
    restart: unless-stopped

  agent-runner:
    build:
      context: .
      args:
        APP_GIT_SHA: ${APP_GIT_SHA:-unknown}
        APP_BUILD_TIME: ${APP_BUILD_TIME:-unknown}
    env_file: .env
    environment:
      TZ: Asia/Taipei
      DB_PATH: /app/data/moltbot.db
      DB_DIR: /app/data
      GEMINI_PROJECT_DIR: /app
      RUNNER_MODE: standalone
      RUNNER_PORT: 8787
      RUNNER_SHARED_SECRET: ${RUNNER_SHARED_SECRET:-}
    volumes:
      - ./data:/app/data
      - ./workspace:/app/workspace
      - gemini_workspace_skills:/app/workspace/.gemini/skills
      - ./ai-config.yaml:/app/ai-config.yaml:ro
      - gemini_auth:/root/.gemini
      - ${HOME}/.local/share/opencode:/root/.local/share/opencode
      - ./skills:/app/skills:ro
      - ./GEMINI.md:/app/workspace/GEMINI.md:ro
      - ./AGENTS.md:/app/workspace/AGENTS.md:ro
    command: ['node', 'dist/runner.js']
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "fetch('http://127.0.0.1:8787/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    restart: unless-stopped

volumes:
  gemini_auth:
  gemini_workspace_skills:
